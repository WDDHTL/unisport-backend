# UniSport 后端代码开发规范

> 适用范围：`unisport-backend` 全部后端代码（Java 17、Spring Boot 3.2、MyBatis-Plus、Redis、JWT、WebSocket、Knife4j）。本规范覆盖日常开发、代码评审和自测。

## 1. 基础约定
- **编码/格式**：UTF-8，4 空格缩进，行尾不留多余空格，单行不超 140 字符；避免 `System.out.println`，统一使用日志。
- **命名**：包名小写单词，类名/接口 PascalCase，方法/变量 camelCase，常量全大写下划线，枚举常量大写；布尔命名以 `is/has/enable` 开头。
- **依赖**：优先使用已引入的框架能力（Spring MVC/Validation/AOP、MyBatis-Plus、Lombok、Hutool）；禁止私自引入坐标到业务模块，需评审通过后更新 `pom.xml`。
- **空值处理**：业务入参统一校验，非必填字段在 Service 层兜底；尽量避免返回 `null`，使用空集合/空字符串或 `Optional`（仅在内部逻辑中）替代。

## 2. 分层与包结构
- **controller**：仅做请求路由、参数校验、调用 Service、返回 `Result` 封装；禁止写业务逻辑或数据库访问。
- **service / service.impl**：承载业务编排、事务、跨聚合逻辑；接口与实现分离，必要时通过 AOP/事务增强。
- **mapper**：继承 MyBatis-Plus `BaseMapper`，查询尽量用 `LambdaQueryWrapper`；自定义 SQL 放在 `src/main/resources/mapper/*.xml`，命名与接口保持一致。
- **entity**：数据库映射实体，仅包含持久化字段；使用 `@TableName`、`@TableId`、`@TableField(fill = …)` 等注解，逻辑删除字段 `deleted` 依赖 MyBatis-Plus 全局配置。
- **dto/vo**：`DTO` 用于入参、`VO` 用于出参视图，避免直接暴露 Entity；命名体现用途，如 `CreatePostDTO`、`PostVO`。
- **common/config/interceptor/utils/WebSocket/Enum/properties**：保持现有职责划分，新增通用能力优先放在对应包内。

## 3. API 设计
- **风格**：RESTful 优先，路径使用名词复数和小写短横线（示例：`/posts/{id}/comments`）；遵循 `GET` 查询、`POST` 创建、`PUT/PATCH` 修改、`DELETE` 删除。
- **版本/前缀**：沿用 `server.servlet.context-path=/api`；如需版本控制，路径追加 `/v1` 等统一前缀。
- **文档**：对外接口使用 `@Tag`、`@Operation` 补充描述；确保 Knife4j/Swagger 能自动生成可读示例和字段说明。
- **分页/过滤**：分页参数统一为 `page`、`pageSize`（或 `size`），默认值在 Service 层兜底；查询条件使用明确字段名，避免模糊语义。

## 4. 入参校验与转换
- 控制器上添加 `@Validated`，方法入参对象使用 `@Valid`；字段使用 `@NotBlank`、`@NotNull`、`@Positive`、`@Size` 等精确约束并提供友好 message。
- 需要枚举约束时使用自定义注解或在 Service 层校验，异常统一抛出 `BusinessException`。
- 复杂类型转换集中在 Service 层，避免在 Controller 直接拼装 Entity；列表转换可结合 `BeanUtils.copyProperties` 或手写映射，确保字段含义一致。

## 5. 返回值规范
- 统一使用 `com.unisport.common.Result` 封装；成功返回 `Result.success(data)`，失败通过 `Result.error(code, message)`。
- 不直接返回 Entity（防止敏感字段泄漏），外部接口返回 VO；分页返回封装为 `PageResult`。
- 前后端约定的业务状态码：4xx 表示业务/校验类问题，5xx 表示系统或未知异常；保持与现有 `BusinessException` 代码风格一致。

## 6. 异常处理
- 业务可预期错误抛出 `BusinessException(code, message)`；不要吞掉异常，捕获后补充业务语义再抛出。
- `GlobalExceptionHandler` 已兜底 `BusinessException`、参数校验异常和系统异常；新增异常类型需在该类补充处理或转换为业务异常。
- 日志记录在抛出点即可，避免重复打印；错误日志带上关键业务上下文（用户 ID、资源 ID），不打印密码、Token 等敏感信息。

## 7. 身份认证与安全
- 统一通过 `Authorization: Bearer <token>` 传递 JWT；认证在 `JwtAuthenticationInterceptor` 处理，白名单接口需更新拦截器逻辑。
- 业务层通过 `UserContext.getUserId()/getSchoolId()` 获取当前主体，不从请求参数接收用户身份；使用后在拦截器 `afterCompletion` 已清理 ThreadLocal。
- 涉及写操作时做资源归属校验、防重放/幂等设计（如点赞/关注使用唯一约束 + 异常捕获）；敏感操作可增加二次校验或速率限制。
- 输入输出需进行基本防护：避免字符串拼接 SQL，使用参数化/Wrapper；返回内容避免暴露内部错误细节或配置。

## 8. 事务与数据访问
- 多表写操作或需要一致性的流程在 Service 方法上使用 `@Transactional(rollbackFor = Exception.class)`；不要在 Controller 层开启事务。
- MyBatis-Plus 查询/更新统一使用 Lambda Wrapper，避免硬编码字段名；批量查询/更新使用 `in`/`updateBatch` 等方式减少 N+1。
- 逻辑删除字段 `deleted` 由全局配置处理，手写 SQL 需显式添加条件；审计字段 `createdAt`、`updatedAt` 由 `MyMetaObjectHandler` 自动填充。
- 分页查询使用 `Page` 对象，限制最大 `pageSize`，防止全表扫描；涉及排序时明确索引字段，避免动态字段注入风险。

## 9. 日志规范
- 使用 `Slf4j` 占位符风格：`log.info("创建帖子, userId={}, postId={}", userId, postId);`。
- `INFO` 记录关键业务里程碑，`WARN` 记录潜在问题（重试、非法参数），`ERROR` 记录失败并附异常栈；禁止在循环中打印大量日志。
- 不打印敏感数据（密码、完整 Token、证件号）；调试日志需在提交前删除或降级。

## 10. 配置与环境
- 配置集中在 `application.properties`，环境差异通过环境变量或 profile 覆盖（如数据库密码、OSS 密钥）；禁用把密钥写死在代码中。
- 新增配置优先使用 `@ConfigurationProperties`（如参考 `JwtProperties`），并在 `docs/` 或 `README` 说明含义和默认值。
- Redis、OSS 等外部依赖需在启动前自检或在 Service 层做降级兜底，避免传播底层异常。

## 11. WebSocket 与消息通知
- WebSocket 入口放在 `WebSocket` 包，保持握手认证与 HTTP 认证一致，必要时校验 Token。
- 推送/通知类场景先写数据库记录再推送（如点赞通知），推送失败需要可重试或记录补偿信息。

## 12. 代码注释与文档
- 公共类/方法使用 Javadoc 说明业务语义、入参/出参、异常；业务流程复杂处可用简短行内注释解释意图，而非解释语法。
- 新增接口同步更新 Knife4j 注解与 `docs/API.md`；数据库变更同步 `docs/database-design.md`。

## 13. 测试与自测
- 单元测试/集成测试使用 `spring-boot-starter-test`，命名以 `*Test` 结尾；Controller 可用 `MockMvc`，Service 可使用内存或 Docker 化依赖。
- 业务变更至少覆盖关键路径：参数校验、成功流、异常流；涉及并发/事务的逻辑写并发或回滚场景用例。
- 本地提交前建议跑 `mvn clean test`（或针对改动模块的局部测试），确保无编译/基础用例失败。

## 14. 提交与评审
- PR 描述需包含变更点、风险、影响范围和自测结果；大改动附架构/流程图。
- 代码评审重点：接口契约是否遵守规范、异常和日志是否到位、事务与安全是否完备、是否影响已有逻辑/性能。
- 与现有风格保持一致，除非评审中明确约定重构；同类问题成组修复，避免“只改一处留下隐患”。

## 15. 常见反例（避免）
- 在 Controller 中写 SQL/事务或直接操作 Mapper。
- 直接返回 Entity 或将敏感字段暴露给前端。
- 未经校验直接信任客户端传入的用户身份、分页参数或排序字段。
- 捕获异常不处理/不记录，或在循环中频繁打印日志。
- 忽略逻辑删除/审计字段、直接 `select *` 全表扫描。

遵循以上规范，可以提升代码一致性、可维护性和可测试性，降低安全与质量风险。
